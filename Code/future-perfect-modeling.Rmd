---
title: "Future Perfect Model"
author: 'Document Author: Jasmine Cui'
output:
  html_document:
    toc: yes
  'html_document:': default
---

```{r message = FALSE}
# Uncomment and run the following four lines to install necessary packages 
# install.packages('tidyverse')
# install.packages('dplyr')
# install.packages('ggplot2')
# install.packages('xtable')
# devtools::install_github('Mikata-Project/ggthemr') 

# Load libraries
library(tidyverse)
library(xtable)
library(ggthemr)

# Set .rmd theme 
ggthemr('fresh')
``` 

# Data Exploration
First, we want to explore ERASE's current emotional approach. We choose to begin by with a macro-level breakdown of which direction ERASE's posts tend to lean towards, generating a histogram which illustrates the frequency with which ERASE opts for a positive, negative, or neutral post tone. 
```{r include = FALSE}
# Load Data 
futurePerfectFeature = 
  read_csv('https://raw.githubusercontent.com/macrodawg/thefutureperfect/main/features-data.csv') 

# Primary Emotion Type 
emotionType = 
  futurePerfectFeature %>% 
  dplyr::filter(., text_primary_emotion != '0') 
  
emotionFreqPlot = 
  ggplot(data = emotionType, aes(text_primary_emotion, fill = text_primary_emotion)) + 
  geom_bar() + 
  xlab('Primary Post Emotion Type') + 
  ylab('Number of Posts') + 
  ggtitle('Distribution of Posts by Primary Emotion Category', subtitle = 'Based on ERASE\'s FB Post History') + 
  guides(fill = guide_legend(title = 'Primary Post Emotion Type'))

print(emotionFreqPlot)
```

From this, it would seem that many of ERASE's posts adopt a positive tone -- below, we can see from the following contingency table that, indeed, a large portion of posts are positive in tone. 
```{r message = FALSE, results = 'asis'}
emotionFrequencies = 
  emotionType %>% 
  dplyr::group_by(., text_primary_emotion) %>% 
  dplyr::summarize(., n = n()) %>% 
  pivot_wider(., names_from = text_primary_emotion, values_from = n) %>% 
  dplyr::mutate(., total = negative + neutral + positive) %>% 
  dplyr::transmute(., negativePCT = negative/total, positivePCT = positive/total, neutralPCT = neutral/total) 

emotionFrequencyTable = 
  emotionFrequencies %>% 
  xtable(.) %>% 
  print(., type = 'html')
```

Of course, as analysts we are interested in more than simply post emotion -- we also want to know how this relates to things like user engagement. 
```{r message = FALSE}
emotionBox = 
  emotionType %>% 
  dplyr::mutate(., logEngagement = log10(emotionType$engagements)) %>% 
  ggplot() + 
  geom_boxplot(aes(x = sort(factor(text_primary_emotion)), y = logEngagement)) + 
  geom_point(aes(x = sort(factor(text_primary_emotion)), y = logEngagement)) + 
  xlab('Primary Post Emotion Type') + 
  ylab('Engagement Levels (Log Transformed)') + 
  ggtitle('Overview of Post Engagement Levels by Primary Emotion', subtitle = 'Based on ERASE\'s FB Post History')

print(emotionBox)
```

Additionally, there are other dimensions to emotion beyond type. For instance, we may also want to look at emotional intensity and how both the type of emotion and its magnitude are related to user engagement.  
```{r message = FALSE}
emotionIntensity = 
  emotionType %>% 
  dplyr::mutate(., logEngagement = log10(engagements)) %>% 
  dplyr::filter(., logEngagement >= 0) %>% 
  ggplot(.) + 
  geom_point(aes(x = text_emotional_intensity, y = logEngagement, color = text_primary_emotion)) + 
  xlab('Engagement by Emotion Type and Intensity') + 
  ylab('Engagement (Log Transformed)') + 
  ggtitle('Engagement Overview by Primary Emotion and Intensity', subtitle = 'Based on ERASE\'s FB Post History') + 
  labs(color = 'Primary Post Emotion Type') 
  
print(emotionIntensity)
```

We can also look at the relationship between the time content is posted and how successful it ends up being in terms of engagement.
```{r message = FALSE}
emotionTime = 
  emotionType %>%
  dplyr::mutate(., created_time = ifelse(is_created_night == 1, 'night', created_time)) %>%
  dplyr::mutate(., created_time = ifelse(is_created_evening == 1, 'evening', created_time)) %>%
  dplyr::mutate(., created_time = ifelse(is_created_morning == 1, 'morning', created_time)) %>% 
  dplyr::mutate(., created_time = ifelse(is_created_afternoon == 1, 'afternoon', created_time)) %>% 
  dplyr::mutate(., logEngagement = log10(emotionType$engagements)) %>% 
  ggplot() + 
  geom_boxplot(aes(y = logEngagement)) + 
  facet_wrap(~ created_time) + 
  xlab(NULL) + 
  ylab('Engagement (Log Transformed)') + 
  ggtitle('Post Engagement by Emotion at Different Times of Day', subtitle = 'Based on ERASE\'s FB Post History')

print(emotionTime)
```

Here, we can use OLS estimation to identify the effect of the time a post is made on a post's success in terms of engagement 
```{r}
engagementTime = 
  emotionType %>% 
  lm(engagements ~ is_created_night + is_created_afternoon + is_created_evening, data = emotionType) %>% summary(.)
```

Elaborating on this, we might also be interested in post timing with relation to other posts; if one post goes viral, it may be the case that the attention this post brings to ERASE's Facebook page also brings attention to immediately subsequent posts.
```{r} 
engagementLag = 
  futurePerfectFeature %>% 
  dplyr::mutate(., log_engagements_last_post = log10(engagements_last_post), log_engagements = log10(engagements)) %>% 
  ggplot(.) + 
  geom_point(aes(x = log_engagements_last_post, y = log_engagements)) + 
  xlab('Engagement Level of Prior Post (Log Transformed)') + 
  ylab('Engagement Level of Current Post (Log Transformed)') + 
  ggtitle('Post Engagement by Emotion at Different Times of Day', subtitle = 'Based on ERASE\'s FB Post History') + 
  geom_smooth(method = 'lm', aes(x = log_engagements_last_post, y = log_engagements))
  
print(engagementLag)
```
Clearly, there is a kind of relationship between the level of success a post achieves and that of the post after it and, furthermore, this relationship is approximately linear. 

# Building up the Model 
```{r}
lm(engagements ~ is_created_night + is_created_afternoon + is_created_evening, data = emotionType) %>% summary(.)



```

# Dashboard Skeleton 
```{r}
isAfternoon = 1 
isnight =0 


.34*afternoon
```

# Random Forest Model -- this can be used build a model which will predict the likelihood of a post succeeding
```{r}
ERASERandomForest = 
  xgboost(data = emotionType %>% 
            dplyr::select(is_created_morning, is_created_afternoon,is_created_evening, is_created_night, text_emotional_intensity) %>% as.matrix(.), label = emotionType$engagements, nrounds = 5)

# Look in the xgboost package for more functions to extract the relevant data 
```

# Probit Model -- this can be used to build a model which will predict the likelihood of a post going viral 
```{r}
isSuccessful = 
isNotSuccessful 
```

# Final Touches + Interpretation
```{r}

```

